{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DA WHITE RESIDENCE - Client List</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Favicons -->
    <link rel="shortcut icon" href="{% static 'img/fav.png' %}" type="image/png">

    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'fonts/font-awesome/css/font-awesome.css' %}">

    <!-- Stylesheet -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/nivo-lightbox/nivo-lightbox.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/nivo-lightbox/default.css' %}">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,800,600,300' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="{% static 'js/modernizr.custom.js' %}"></script>
    <style>
        .negative-balance { color: red; }
        .receipt-toggle { cursor: pointer; text-decoration: underline; }
        .receipt-details { display: none; margin-top: 10px; }
    </style>
</head>
<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">
    <!-- Navigation -->
    <nav id="menu" class="navbar navbar-inverse navbar-fixed-top">
        <div class="container"> 
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" 
                        data-target="#bs-example-navbar-collapse-1"> 
                    <span class="sr-only">Toggle navigation</span> 
                    <span class="icon-bar"></span> 
                    <span class="icon-bar"></span> 
                    <span class="icon-bar"></span> 
                </button>
                <a class="navbar-brand page-scroll" href="{% url 'index' %}">
                    <i class="fa fa-play fa-code"></i> DA WHITE RESIDENCE
                </a> 
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="{% url 'index' %}">Home</a></li>
                    <li><a href="{% url 'customer_status' %}">Client</a></li>
                    <li><a href="{% url 'contact' %}">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px;">
        <h2>Client List</h2>
        <p>DEBUG: {{ clients|length }} clients found.</p>
        {% if client_form.errors %}
            <p>Client Form Errors: {{ client_form.errors }}</p>
        {% endif %}
        {% if receipt_form.errors %}
            <p>Receipt Form Errors: {{ receipt_form.errors }}</p>
        {% endif %}

        <!-- Add Client Form -->
        <h3>Add New Client</h3>
        <form method="post" name="add_client">
            {% csrf_token %}
            {{ client_form.as_p }}
            <button type="submit" name="add_client" class="btn btn-primary">Add Client</button>
        </form>

        <!-- Add Receipt Form -->
        <h3>Add Receipt</h3>
        <form method="post" name="add_receipt">
            {% csrf_token %}
            {{ receipt_form.as_p }}
            <button type="submit" name="add_receipt" class="btn btn-primary">Add Receipt</button>
        </form>

        <!-- Client List Table -->
        <table class="table table-bordered" style="margin-top: 20px;">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Contact</th>
                    <th>Room Price/Day</th>
                    <th>Days Stayed</th>
                    <th>Beer Price</th>
                    <th>Beers Taken</th>
                    <th>Amount Paid</th>
                    <th>Total Due</th>
                    <th>Balance</th>
                    <th>Receipts</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer_status in clients %}
                <tr>
                    <td>{{ customer_status.user.username }}</td>
                    <td>{{ customer_status.contact|default:"N/A" }}</td>
                    <td>{{ customer_status.room_price_per_day }}</td>
                    <td>{{ customer_status.days_stayed }}</td>
                    <td>{{ customer_status.beer_price }}</td>
                    <td>{{ customer_status.beers_taken }}</td>
                    <td>{{ customer_status.amount_paid }}</td>
                    <td>{{ customer_status.compute_total_due }}</td>
                    <td class="{% if customer_status.compute_balance < 0 %}negative-balance{% endif %}">
                        {{ customer_status.compute_balance }}
                    </td>
                    <td>
                        <span class="receipt-toggle" onclick="toggleReceipts('receipts-{{ customer_status.id }}')">View Receipts</span>
                        <div id="receipts-{{ customer_status.id }}" class="receipt-details">
                            {% for receipt in customer_status.receipts.all %}
                                <p>Receipt #{{ receipt.id }}: {{ receipt.amount }} - {{ receipt.description }} ({{ receipt.created_at }})</p>
                            {% empty %}
                                <p>No receipts found.</p>
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <form method="post" onsubmit="return confirm('Are you sure you want to delete {{ customer_status.user.username }}?');">
                            {% csrf_token %}
                            <input type="hidden" name="client_id" value="{{ customer_status.id }}">
                            <button type="submit" name="delete_client" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11">No clients found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Scripts -->
    <script type="text/javascript" src="{% static 'js/jquery.1.11.1.js' %}"></script> 
    <script type="text/javascript" src="{% static 'js/bootstrap.js' %}"></script> 
    <script type="text/javascript" src="{% static 'js/SmoothScroll.js' %}"></script> 
    <script type="text/javascript" src="{% static 'js/nivo-lightbox.js' %}"></script> 
    <script type="text/javascript" src="{% static 'js/jquery.isotope.js' %}"></script> 
    <script type="text/javascript" src="{% static 'js/jqBootstrapValidation.js' %}"></script> 
    <script type="text/javascript" src="{% static 'js/contact_me.js' %}"></script> 
    <script type="text/javascript" src="{% static 'js/main.js' %}"></script>
    <script>
        function toggleReceipts(id) {
            var element = document.getElementById(id);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>